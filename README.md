![MIT](https://img.shields.io/badge/License-Apache2.0-blue.svg) ![JDK](https://img.shields.io/badge/JDK-8+-green.svg) ![SpringBoot](https://img.shields.io/badge/Srping%20Boot-2.3.0+-green.svg) ![redis](https://img.shields.io/badge/Redis-5.0+-green.svg) ![rebbitmq](https://img.shields.io/badge/RabbitMQ-3.8.0+-green.svg)![rocketmq](https://img.shields.io/badge/RocketMQ-4.0+-green.svg)

eventbusåŸºäºSpring Boot Starterçš„åˆ†å¸ƒå¼ä¸šåŠ¡æ¶ˆæ¯åˆ†å‘æ€»çº¿ç»„ä»¶ï¼ˆå‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼‰ï¼Œæ”¯æŒå»¶æ—¶æ¶ˆæ¯ã€‚å¯ä½¿ç”¨Redisã€RabbitMQã€RocketMQç­‰ä»»æ„ä¸€ç§åšåº•å±‚çš„æ¶ˆæ¯å¼•æ“ï¼ŒğŸ” ğŸ” ğŸ”å¼€æºä¸æ˜“ï¼Œç‚¹ä¸ªStarå…³æ³¨æ›´æ–°å§ã€‚

Githubé¡¹ç›®åœ°å€ï¼š[https://github.com/likavn/eventbus](https://github.com/likavn/eventbus) <br/>
Giteeé¡¹ç›®åœ°å€ï¼š[https://gitee.com/likavn/eventbus](https://gitee.com/likavn/eventbus)

## eventbusç®€ä»‹

eventbusæ˜¯åˆ†å¸ƒå¼ä¸šåŠ¡æ¶ˆæ¯åˆ†å‘æ€»çº¿ç»„ä»¶ï¼Œæ”¯æŒå¹¿æ’­åŠæ—¶æ¶ˆæ¯ã€å»¶æ—¶æ¶ˆæ¯ç­‰ï¼ˆå³å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼‰ã€‚ç»„ä»¶é€šè¿‡å±è”½åº•å±‚ä¸åŒç§ç±»çš„æ¶ˆæ¯å¼•æ“ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„æ¥å£è°ƒç”¨ï¼Œå¯å‘é€åŠæ—¶æ¶ˆæ¯å’Œå»¶æ—¶æ¶ˆæ¯ï¼ŒåŒæ—¶å¯è®¢é˜…åŠæ—¶æ¶ˆæ¯æˆ–å»¶æ—¶æ¶ˆæ¯ç­‰ã€‚å½“æˆ‘ä»¬çš„åº”ç”¨å¼•å…¥eventbusç»„ä»¶æ—¶å¯é™ä½ç³»ç»Ÿè€¦åˆåº¦ã€‚ç›®å‰å¯é€‰æ‹©åŸºäºRedisã€RabbitMQã€RocketMQç­‰ä»»æ„ä¸€ç§åšåº•å±‚çš„æ¶ˆæ¯å¼•æ“ï¼Œå…¶ä»–æ¶ˆæ¯å¼•æ“ä¸­é—´ä»¶å°†è¢«é™†ç»­æ”¯æŒã€‚

æ³¨æ„ï¼šå®ƒä¸å±äº`æ¶ˆæ¯ä¸­é—´ä»¶`ï¼Œå®ƒæ˜¯é€šè¿‡å’Œæ¶ˆæ¯ä¸­é—´ä»¶è¿›è¡Œæ•´åˆï¼Œæ¥å®ŒæˆæœåŠ¡ä¹‹é—´çš„æ¶ˆæ¯é€šè®¯ï¼Œç±»ä¼¼äºæ¶ˆæ¯ä»£ç†ã€‚

## æ”¯æŒçš„æ¶ˆæ¯ä¸­é—´ä»¶

- Redis
- RabbitMQ
- RocketMQ

## æœ‰å“ªäº›ç‰¹ç‚¹

æˆ‘ä»¬ä¸æ˜¯å¦å¤–å¼€å‘ä¸€ä¸ªMQï¼Œè€Œæ˜¯å±è”½åº•å±‚ä¸åŒç§ç±»çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„æ¥å£è°ƒç”¨ï¼Œæ—¨åœ¨æä¾›ç®€å•çš„äº‹ä»¶å¤„ç†ç¼–ç¨‹æ¨¡å‹ï¼Œè®©åŸºäºäº‹ä»¶çš„å¼€å‘æ›´çµæ´»ç®€å•ï¼Œç»“æ„æ¸…æ™°æ˜“äºç»´æŠ¤ï¼Œæ‰©å±•æ–¹ä¾¿ï¼Œé›†æˆä½¿ç”¨æ›´ç®€å•ã€‚

## æœ‰å“ªäº›åŠŸèƒ½

- æ¶ˆæ¯ï¼šæ”¯æŒåŠæ—¶æ¶ˆæ¯ã€å»¶æ—¶æ¶ˆæ¯çš„æŠ•é€’å’Œæ¥æ”¶ï¼Œæ”¯æŒé€šè¿‡å¤šç§æ–¹å¼è®¢é˜…æ¶ˆæ¯ï¼Œå¯é€šè¿‡ç»Ÿä¸€çš„æ¥å£å’Œæ³¨è§£æ–¹å¼å»è®¢é˜…æ¥æ”¶æ¶ˆæ¯ï¼›
- å¤±è´¥é‡è¯•ï¼šæ”¯æŒæ¶ˆæ¯æŠ•é€’å¤±è´¥æ—¶æŠ•é€’é‡è¯•ï¼Œå¯è‡ªå®šä¹‰å¤±è´¥é‡è¯•æŠ•é€’æ¬¡æ•°åŠä¸‹æ¬¡æŠ•é€’æ—¶é—´ï¼›
- æ‹¦æˆªå™¨ï¼šæ”¯æŒå…¨å±€æ‹¦æˆªå™¨ï¼Œå¯è‡ªä¸»å®ç°æ‹¦æˆªé€»è¾‘ï¼Œæ”¯æŒå‘é€å‰æ‹¦æˆªï¼ˆ`SendBeforeInterceptor `ï¼‰ã€å‘é€åæ‹¦æˆªï¼ˆ`SendAfterInterceptor `
  ï¼‰ã€æŠ•é€’å‰æ‹¦æˆªï¼ˆ`DeliverBeforeInterceptor`ï¼‰ã€æŠ•é€’åæ‹¦æˆªï¼ˆ`DeliverAfterInterceptor`ï¼‰ã€æœ€åä¸€æ¬¡æŠ•é€’ä»ç„¶å¤±è´¥æ—¶æ‹¦æˆªï¼ˆ
  `DeliverThrowableLastInterceptor`ï¼‰ï¼›
- æ¶ˆæ¯è½®è¯¢ï¼šé€šè¿‡æ³¨è§£[@Polling](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/Polling.java)  è‡ªå®šä¹‰æ¶ˆæ¯çš„è½®è¯¢è¡Œä¸ºï¼›
- åŠæ—¶æ¶ˆæ¯è½¬æ¢ä¸ºå»¶æ—¶æ¶ˆæ¯ï¼šé€šè¿‡æ³¨è§£[@ToDelay](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/ToDelay.java)å®šä¹‰æ¶ˆæ¯ç±»å‹è½¬æ¢ï¼Œæ”¯æŒæ¶ˆæ¯å‘é€æ—¶ï¼Œå°†æ¶ˆæ¯è½¬æ¢ä¸ºå»¶æ—¶æ¶ˆæ¯ï¼Œå»¶æ—¶æ¶ˆæ¯æ”¯æŒå»¶æ—¶æŠ•é€’ï¼Œæ”¯æŒå»¶æ—¶æŠ•é€’æ—¶é—´é…ç½®ï¼›
- æä¾›æ¶ˆæ¯æŒä¹…åŒ–ç¤ºä¾‹ï¼Œå¯å‚è€ƒ[BsHelper](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/helper/BsHelper.java)ï¼ŒæŒä¹…åŒ–æ¶ˆæ¯æŠ•é€’çŠ¶æ€ï¼Œå¯ä¾¿äºåç»­å¤„ç†ï¼›
- å¯æ§çš„æ¶ˆæ¯è®¢é˜…ç›‘å¬å™¨å¼€å…³ï¼Œå¦‚é€šè¿‡`Nacos`ä¸‹çº¿æŸä¸ªæœåŠ¡å®ä¾‹æ—¶éœ€è¦åŒæ—¶å…³é—­æ¶ˆæ¯çš„ç›‘å¬ï¼›
- æ”¯æŒæ— éœ€ä¿®æ”¹ä»£ç ï¼Œæ— ç¼åˆ‡æ¢æ¶ˆæ¯ä¸­é—´ä»¶ï¼›
- æ¶ˆæ¯ä¸­é—´ä»¶ç½‘ç»œæ–­å¼€é‡è¿æœºåˆ¶ï¼Œæ”¯æŒé‡è¿ï¼›

## æœ‰å“ªäº›åœºæ™¯å¯ä»¥ä½¿ç”¨

- å•ä¸€ä¸šåŠ¡åˆ†å‘æ¶ˆæ¯è¿›è¡Œå¼‚æ­¥å¤„ç†æ—¶ï¼Œæ¯”å¦‚ä¸šåŠ¡å®Œæˆæ¨é€ä¸šåŠ¡æ•°æ®ç»™ç¬¬ä¸‰æ–¹ï¼›
- æ”¯ä»˜æ—¶ï¼Œåç«¯æœåŠ¡éœ€è¦å®šæ—¶è½®è¯¢æ”¯ä»˜æ¥å£æŸ¥è¯¢æ˜¯å¦æ”¯ä»˜æˆåŠŸï¼ˆå¯é…ç½®æ¶ˆæ¯è½®è¯¢ï¼‰ï¼›
- ç³»ç»Ÿä¸šåŠ¡æ¶ˆæ¯ä¼ æ’­è§£è€¦ï¼Œé™ä½æ¶ˆæ¯æŠ•é€’å’Œæ¥æ”¶çš„å¤æ‚åº¦ï¼ˆæ¶ˆæ¯å¯é æ€§ä¼ é€’ï¼‰ï¼›
- å½“æˆ‘ä»¬éœ€è¦åˆ‡æ¢æ¶ˆæ¯ä¸­é—´ä»¶æ—¶ï¼Œå¯ä»¥åšåˆ°æ— ç¼åˆ‡æ¢ï¼Œä¸éœ€è¦ä¿®æ”¹ä¸šåŠ¡ä»£ç ï¼›

## ç‰ˆæœ¬è¦æ±‚

1. SpringBoot 2.3.0+
2. Redis 5.0+
3. RabbitMQ 3.8.0+
4. RocketMQ 4.0+

## å¿«é€Ÿå¼€å§‹

### å¼•å…¥ä¾èµ–

é¡¹ç›®ä¸­å¿…é¡»å¼•å…¥`eventbus-spring-boot-starter`ç»„ä»¶ä¾èµ–</br>
Spring Boot2
```xml
<!-- å¿…é¡»å¼•å…¥ eventbus-spring-boot-starterç»„ä»¶-->
<dependency>
    <groupId>com.github.likavn</groupId>
  <artifactId>eventbus-spring-boot-starter</artifactId>
  <version>2.5.0-RC3</version>
</dependency>
```

Spring Boot3
```xml
<!-- å¿…é¡»å¼•å…¥ eventbus-spring-boot-starterç»„ä»¶-->
<dependency>
    <groupId>com.github.likavn</groupId>
  <artifactId>eventbus-spring-boot3-starter</artifactId>
  <version>2.5.0-RC3</version>
</dependency>
```

`Json`åºåˆ—åŒ–å·¥å…·æ”¯æŒ`Fast2json`ã€`Fastjson`ã€`Jackson`ã€`Gson`ç­‰ä»»æ„ä¸€ç§ã€‚é¡¹ç›®å·²å¼•å…¥`spring-boot-starter-web`æ—¶è‡ªå¸¦`Jackson`ä¾èµ–ï¼Œä¸éœ€è¦å•ç‹¬å¼•å…¥å…¶ä»–`Json`å·¥å…·ä¾èµ–ã€‚å¦‚æœé¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ª`Json`åºåˆ—åŒ–å·¥å…·ä¾èµ–ï¼Œåºåˆ—åŒ–æ—¶çš„ä¼˜å…ˆçº§å¦‚ä¸‹:

```xml
<!-- å„JSONåºåˆ—åŒ–å·¥å…· ä»»é€‰ä¸€ä¸ª-->
<!-- fastjson2 -->
<dependency>
    <groupId>com.alibaba.fastjson2</groupId>
    <artifactId>fastjson2</artifactId>
    <version>${version}</version>
</dependency>
<!-- fastjson -->
<dependency>
     <groupId>com.alibaba</groupId>
     <artifactId>fastjson</artifactId>
     <version>${version}</version>
</dependency>
<!-- jackson å¦‚æœé¡¹ç›®å·²å¼•å…¥spring-boot-starter-webï¼Œé¡¹ç›®è‡ªå¸¦jacksonä¾èµ–ï¼Œä¸éœ€è¦å•ç‹¬å¼•å…¥-->
<dependency>
     <groupId>com.fasterxml.jackson.core</groupId>
     <artifactId>jackson-databind</artifactId>
     <version>${version}</version>
</dependency>
<!-- gson -->
<dependency>
     <groupId>com.google.code.gson</groupId>
     <artifactId>gson</artifactId>
     <version>${version}</version>
</dependency>
```

### è®¾ç½®æ¶ˆæ¯ä¸­é—´ä»¶

åœ¨application.ymlæ–‡ä»¶ä¸­é…ç½®æ¶ˆæ¯å¼•æ“ç±»å‹ï¼Œå¦‚ä¸‹ï¼š

```yaml
eventbus:
  type: redis  #redisæˆ–è€…rabbitmqã€rocketmq
```

#### redis

ä½¿ç”¨Redis5.0 æ–°åŠŸèƒ½Streamï¼ŒRedis Stream æä¾›äº†æ¶ˆæ¯çš„æŒä¹…åŒ–å’Œä¸»å¤‡å¤åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥è®©ä»»ä½•å®¢æˆ·ç«¯è®¿é—®ä»»ä½•æ—¶åˆ»çš„æ•°æ®ï¼Œå¹¶ä¸”èƒ½è®°ä½æ¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„è®¿é—®ä½ç½®ï¼Œè¿˜èƒ½ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚é»˜è®¤ä½¿ç”¨éé˜»å¡è½®è¯¢æ‹‰å–Streamä¸­çš„æ¶ˆæ¯ï¼Œå¯é…ç½®ä½¿ç”¨é˜»å¡æ¨¡å¼æ‹‰å–æ¶ˆæ¯ã€‚

æ³¨ï¼šredis 5.0~<6.2çš„ç‰ˆæœ¬åˆ é™¤è¿‡æœŸæ¶ˆæ¯æ˜¯é€šè¿‡æˆªå–streamé•¿åº¦å®ç°çš„ï¼Œé»˜è®¤ä¿ç•™streamä¸­çš„æ•°æ®é•¿åº¦ä¸º10000æ¡ï¼Œ>=6.2ç‰ˆæœ¬æ—¶å¯é…ç½®æ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¿ç•™5å¤©å†…çš„æ¶ˆæ¯æ•°æ®ã€‚å»¶æ—¶æ¶ˆæ¯æ¥æ”¶å¹¶å¤„ç†åï¼Œé»˜è®¤å³åˆ»åˆ é™¤streamä¸­çš„æ¶ˆæ¯ã€‚

éœ€è¦åœ¨pom.xmlå•ç‹¬å¼•å…¥ï¼Œå¦‚ä¸‹ï¼š

```xml
<dependency>
     <groupId>org.springframework.boot</groupId>
     <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
     <groupId>org.apache.commons</groupId>
     <artifactId>commons-pool2</artifactId>
</dependency>
```

#### RabbitMQ

åº•å±‚ä½¿ç”¨`RabbitMQ`å‘é€å»¶æ—¶æ¶ˆæ¯æ—¶ï¼Œéœ€å®‰è£…`RabbitMQ`çš„å»¶æ—¶æ¶ˆæ¯æ’ä»¶`rabbitmq_delayed_message_exchange`ã€‚

rabbitmqéœ€è¦åœ¨pom.xmlå•ç‹¬å¼•å…¥ï¼Œå¦‚ä¸‹ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

#### RocketMQ

rocketmqéœ€è¦åœ¨pom.xmlå•ç‹¬å¼•å…¥ï¼ˆrocketMQä¼šå¼•å…¥fastjsonï¼‰ï¼Œå¦‚ä¸‹ï¼š

```xml
<dependency>
     <groupId>org.apache.rocketmq</groupId>
     <artifactId>rocketmq-spring-boot-starter</artifactId>
     <version>2.3.1</version>
</dependency>
```

### å‘é€ä¸è®¢é˜…åŠæ—¶æ¶ˆæ¯

#### æ˜¾ç¤ºç¼–ç 

å‘é€ä¸è®¢é˜…æ¶ˆæ¯éƒ½æ˜¾ç¤ºçš„æŒ‡å®šæ¶ˆæ¯ç¼–ç 

å‘é€æ¶ˆæ¯

```java
@Resource
private MsgSender msgSender;

// å‘é€åŠæ—¶æ¶ˆæ¯
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸šåŠ¡æ¶ˆæ¯code
// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸šåŠ¡æ¶ˆæ¯Objectå®ä½“å¯¹è±¡æ•°æ®
msgSender.send("testMsgSubscribe", "charging");
```

è®¢é˜…æ¶ˆæ¯

```java
/**
 * è®¢é˜…åŠæ—¶æ¶ˆæ¯
 * ç»§æ‰¿æ¥å£ã€MsgListenerã€‘å¹¶è®¾ç½®ç›‘å¬çš„æ¶ˆæ¯å®ä½“å¯¹è±¡
 */
@Component
@EventbusListener(codes = "testMsgSubscribe")
public class DemoMsgListener extends MsgListener<String> {
    // æ¥æ”¶ä¸šåŠ¡æ¶ˆæ¯ä½“å¯¹è±¡æ•°æ®
    @Override
    public void onMessage(Message<String> message) {
        String body = message.getBody();
    }
}
```

#### æ¶ˆæ¯å®ä½“ç»§æ‰¿MsgBodyæ¥å£

å¯è®©æ¶ˆæ¯å®ä½“ç»§æ‰¿æ¥å£`MsgBody`ï¼Œå¹¶å¯åœ¨å®ä½“ä¸­å®šä¹‰æ¶ˆæ¯ç¼–ç ï¼ˆå¯é‡å†™codeæ–¹æ³•ï¼Œä¹Ÿå¯ä¸é‡å†™ï¼Œæ­¤æ—¶é»˜è®¤ä¸ºç»§æ‰¿`MsgBody`æ¥å£çš„beanå®ä½“ç±»åç§°ï¼‰ï¼Œä½¿å¾—åŒä¸€æ¶ˆæ¯ç¼–ç çš„æ¶ˆæ¯åœ¨å®šä¹‰ç›‘å¬å™¨æˆ–å‘é€æ¶ˆæ¯æ—¶ä¸éœ€è¦å•ç‹¬è®¾ç½®æ¶ˆæ¯ç¼–ç ã€‚

å®šä¹‰æ¶ˆæ¯å®ä½“

```java
@Data
public class TestBody implements MsgBody {
    private String content;

    // å¯é‡å†™codeæ–¹æ³•ï¼Œä¹Ÿå¯ä¸é‡å†™ï¼Œè¿™é‡Œä¸é‡å†™æ—¶é»˜è®¤çš„æ¶ˆæ¯ç¼–ç code=TestBody ï¼ˆç»§æ‰¿MsgBodyæ¥å£ç±»çš„åç§°ï¼‰
    @Override
    public String code() {
        return MsgConstant.TEST_MSG_SUBSCRIBE_LISTENER;
    }
}
```

å‘é€æ¶ˆæ¯

```java
@Resource
private MsgSender msgSender;

// å‘é€æ¶ˆæ¯
TestBody testBody = new TestBody();
testBody.setContent("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼ï¼ï¼");
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸šåŠ¡æ¶ˆæ¯Objectå®ä½“å¯¹è±¡æ•°æ®
msgSender.send(testBody);
```

è®¢é˜…æ¶ˆæ¯</br>
å®šä¹‰æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆä¸éœ€è¦æŒ‡å®šæ¶ˆæ¯ç¼–ç ï¼‰ï¼Œå¦‚ä¸‹ï¼š

```java
@Slf4j
@Component
@EventbusListener
public class DemoMsgListener2 extends MsgListener<TestBody> {

    @Override
    public void onMessage(Message<TestBody> message) {
        TestBody body = message.getBody();
    }
}
```

#### æŒ‡å®šç›‘å¬å™¨å®ç°ç±»

å‘é€æ¶ˆæ¯

```java
// å‘é€æ¶ˆæ¯
@Resource
private MsgSender msgSender;

// å‘é€æ¶ˆæ¯
String testBody = "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼ï¼ï¼";
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŠæ—¶æ¶ˆæ¯ç›‘å¬å™¨å®ç°ç±»
// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸šåŠ¡æ¶ˆæ¯Objectå®ä½“å¯¹è±¡æ•°æ®
msgSender.send(DemoMsgListener3.class, testBody);
```

è®¢é˜…æ¶ˆæ¯</br>
å®šä¹‰æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆä¸éœ€è¦æŒ‡å®šæ¶ˆæ¯ç¼–ç ï¼Œé»˜è®¤æ¶ˆæ¯ç¼–ç ä¸ºç›‘å¬å™¨ç±»åï¼‰ï¼Œå¦‚ä¸‹ï¼š

```java
@Component
@EventbusListener
public class DemoMsgListener3 extends MsgListener<String> {
    @Override
    public void onMessage(Message<String> message) {
      String body = message.getBody();
    }
}
```

### å‘é€ä¸è®¢é˜…å»¶æ—¶æ¶ˆæ¯

æ³¨æ„ï¼šå½“æ¶ˆæ¯å¼•æ“ä¸ºrocketMqæ—¶ï¼Œå»¶æ—¶æ—¶é—´å¯¹åº”ä¸ºrocketMqçš„18ä¸ªå»¶æ—¶çº§åˆ«ã€‚

#### æ˜¾ç¤ºç¼–ç 

å‘é€ä¸è®¢é˜…æ¶ˆæ¯éƒ½æ˜¾ç¤ºçš„æŒ‡å®šæ¶ˆæ¯ç¼–ç 

å‘é€å»¶æ—¶æ¶ˆæ¯

```java
@Resource
private MsgSender msgSender;

// å‘é€å»¶æ—¶æ¶ˆæ¯
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸šåŠ¡æ¶ˆæ¯code
// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸šåŠ¡æ¶ˆæ¯Objectå®ä½“å¯¹è±¡æ•°æ®
// ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå»¶æ—¶æ—¶é—´ï¼Œå•ä½ï¼šç§’ï¼Œå½“æ¶ˆæ¯å¼•æ“ä¸ºrocketMqæ—¶ï¼Œå»¶æ—¶æ—¶é—´å¯¹åº”ä¸ºrocketMqçš„18ä¸ªå»¶æ—¶çº§åˆ«ã€‚
msgSender.sendDelayMessage("testMsgSubscribe", "charging"ï¼Œ5);
```

è®¢é˜…å»¶æ—¶æ¶ˆæ¯

```java
/**
 * è®¢é˜…å»¶æ—¶æ¶ˆæ¯
 * ç»§æ‰¿æ¥å£ã€MsgDelayListenerã€‘å¹¶è®¾ç½®ç›‘å¬çš„æ¶ˆæ¯å®ä½“å¯¹è±¡
 */
@Component
@EventbusListener(codes = "testMsgSubscribe")
public class DemoDelayMsgListener extends MsgDelayListener<String> {
    // æ¥æ”¶ä¸šåŠ¡æ¶ˆæ¯ä½“å¯¹è±¡æ•°æ®
    @Override
    public void onMessage(Message<String> message) {
        String body = message.getBody();
    }
}
```

#### æ¶ˆæ¯å®ä½“ç»§æ‰¿MsgBodyæ¥å£

å¯è®©æ¶ˆæ¯å®ä½“ç»§æ‰¿æ¥å£`MsgBody`ï¼Œå¹¶å¯åœ¨å®ä½“ä¸­å®šä¹‰æ¶ˆæ¯ç¼–ç ï¼ˆå¯é‡å†™codeæ–¹æ³•ï¼Œä¹Ÿå¯ä¸é‡å†™ï¼Œæ­¤æ—¶é»˜è®¤ä¸ºç»§æ‰¿`MsgBody`æ¥å£çš„beanå®ä½“ç±»åç§°ï¼‰ï¼Œä½¿å¾—åŒä¸€æ¶ˆæ¯ç¼–ç çš„æ¶ˆæ¯åœ¨å®šä¹‰ç›‘å¬å™¨æˆ–å‘é€æ¶ˆæ¯æ—¶ä¸éœ€è¦å•ç‹¬è®¾ç½®æ¶ˆæ¯ç¼–ç ã€‚

å®šä¹‰å»¶æ—¶æ¶ˆæ¯æ¶ˆæ¯å®ä½“

```java
@Data
public class TestBody implements MsgBody {
    private String content;

    // å¯é‡å†™codeæ–¹æ³•ï¼Œä¹Ÿå¯ä¸é‡å†™ï¼Œè¿™é‡Œä¸é‡å†™æ—¶é»˜è®¤çš„æ¶ˆæ¯ç¼–ç code=TestBody ï¼ˆç»§æ‰¿MsgBodyæ¥å£ç±»çš„åç§°ï¼‰
    @Override
    public String code() {
        return "DelayCode";
    }
}
```

å‘é€å»¶æ—¶æ¶ˆæ¯

```java
@Resource
private MsgSender msgSender;

// æ¶ˆæ¯å®ä½“
TestBody testBody = new TestBody();
testBody.setContent("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼ï¼ï¼");

// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸šåŠ¡æ¶ˆæ¯Objectå®ä½“å¯¹è±¡æ•°æ®
// ç¬¬äºŒä¸ªå‚æ•°ä¸ºå»¶æ—¶æ—¶é—´ï¼Œå•ä½ï¼šç§’ï¼Œå½“æ¶ˆæ¯å¼•æ“ä¸ºrocketMqæ—¶ï¼Œå»¶æ—¶æ—¶é—´å¯¹åº”ä¸ºrocketMqçš„18ä¸ªå»¶æ—¶çº§åˆ«ã€‚
msgSender.sendDelayMessage(testBody, 2);
```

è®¢é˜…å»¶æ—¶æ¶ˆæ¯</br>
å®šä¹‰å»¶æ—¶æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆä¸éœ€è¦æŒ‡å®šæ¶ˆæ¯ç¼–ç ï¼‰ï¼Œå¦‚ä¸‹ï¼š

```java
@Slf4j
@Component
@EventbusListener
public class DemoDelayMsgListener2 extends MsgDelayListener<TestBody> {

    @Override
    public void onMessage(Message<TestBody> message) {
        TestBody body = message.getBody();
    }
}
```

#### æŒ‡å®šç›‘å¬å™¨å®ç°ç±»

å‘é€å»¶æ—¶æ¶ˆæ¯

```java
@Resource
private MsgSender msgSender;

// å‘é€å»¶æ—¶æ¶ˆæ¯
String testBody = "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼ï¼ï¼";
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å»¶æ—¶æ¶ˆæ¯ç›‘å¬å™¨å®ç°ç±»
// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸šåŠ¡æ¶ˆæ¯Objectå®ä½“å¯¹è±¡æ•°æ®
// ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå»¶æ—¶æ—¶é—´ï¼Œå•ä½ï¼šç§’ï¼Œå½“æ¶ˆæ¯å¼•æ“ä¸ºrocketMqæ—¶ï¼Œå»¶æ—¶æ—¶é—´å¯¹åº”ä¸ºrocketMqçš„18ä¸ªå»¶æ—¶çº§åˆ«ã€‚
msgSender.sendDelayMessage(DemoDelayMsgListener3.class, testBody, 2);
```

è®¢é˜…å»¶æ—¶æ¶ˆæ¯</br>
å®šä¹‰å»¶æ—¶æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆä¸éœ€è¦æŒ‡å®šæ¶ˆæ¯ç¼–ç ï¼Œé»˜è®¤æ¶ˆæ¯ç¼–ç ä¸ºç›‘å¬å™¨ç±»åï¼‰ï¼Œå¦‚ä¸‹ï¼š

```java
@Component
@EventbusListener
public class DemoDelayMsgListener3 extends MsgDelayListener<String> {
    @Override
    public void onMessage(Message<String> message) {
      String body = message.getBody();
    }
}
```

### å¼‚å¸¸æ•è·ä¸é‡è¯•

å½“æ¶ˆæ¯æŠ•é€’å¤±è´¥æ—¶ï¼Œå¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯é‡å¤æŠ•é€’æ¬¡æ•°å’Œä¸‹æ¬¡æ¶ˆæ¯æŠ•é€’æ—¶é—´é—´éš”ï¼ˆç³»ç»Ÿé»˜è®¤é‡å¤æŠ•é€’3æ¬¡ï¼Œæ¯æ¬¡é—´éš”10ç§’ï¼‰ï¼Œå³ä¾¿è¿™æ ·ï¼Œæ¶ˆæ¯è¿˜æ˜¯æœ‰å¯èƒ½ä¼šå­˜åœ¨æŠ•é€’ä¸æˆåŠŸçš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨æ³¨è§£`@FailRetry`æ ‡è¯†åœ¨æ¶ˆæ¯å¤„ç†å™¨çš„æ¥æ”¶æ–¹æ³•ä¸Šã€‚<br/>å¦‚è¦æ•è·å¼‚å¸¸ï¼Œéœ€é‡å†™`failHandler`æ–¹æ³•å³å¯æ•è·æŠ•é€’é”™è¯¯å¼‚å¸¸åŠæ•°æ®ã€‚å¦‚ä¸‹ï¼š

```java
@Slf4j
@Component
@EventbusListener(codes = "testMsgSubscribe")
public class DemoMsgSubscribeListener extends MsgListener<String> {
    // æ¥æ”¶ä¸šåŠ¡æ¶ˆæ¯ä½“å¯¹è±¡æ•°æ®
    // @FailRetryæ¶ˆæ¯æŠ•é€’å¤±è´¥æ—¶é‡è¯•ï¼Œè¿™é‡Œè®¾ç½®é‡è¯•2æ¬¡ï¼Œä¸‹æ¬¡é‡è¯•é—´éš”5ç§’ï¼ˆå¼•æ“ä¸ºrocketMqæ—¶ï¼Œæ­¤å¤„å»¶æ—¶æ—¶é—´å¯¹åº”ä¸ºrocketMqçš„18ä¸ªå»¶æ—¶çº§åˆ«ï¼‰åè§¦å‘
    @Override
    @FailRetry(retry = 2, nextTime = 5)
    public void onMessage(Message<String> message) {
        String body = message.getBody();
        log.info("æ¥æ”¶æ•°æ®: {}", message.getRequestId());
        // throw new RuntimeException("DemoMsgSubscribeListener test");
    }

    /**
     * æ¶ˆæ¯æŠ•é€’å¼‚å¸¸æ•è·
     */
    @Override
    public void failHandler(Message<String> message, Throwable throwable) {
        log.error("æ¶ˆæ¯æŠ•é€’å¤±è´¥ï¼: {}ï¼Œ{}", message.getRequestId(), throwable.getMessage());
    }
}
```

## é«˜çº§ä½¿ç”¨

### è‡ªå®šä¹‰æ¶ˆæ¯ID

RequestIdï¼ˆæ¶ˆæ¯IDï¼‰é»˜è®¤ä½¿ç”¨UUIDï¼Œè‹¥éœ€ä¿®æ”¹ä¸ºå…¶ä»–ç±»å‹çš„IDï¼Œå¯å®ç°æ¥å£[RequestIdGenerator](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/RequestIdGenerator.java) æ—¶é‡å†™`nextId()`æ–¹æ³•å¹¶é…ç½®å³å¯ã€‚

æ¥å£ï¼š

```java
public interface RequestIdGenerator {
    /**
     * è·å–è¯·æ±‚ID
     *
     * @return è¯·æ±‚ID
     */
    String nextId();
}
```

å®ç°å¹¶é…ç½®ï¼š

```java
@Configuration
public class EventbusConfiguration {

    @Bean
    public RequestIdGenerator requestIdGenerator() throws UnknownHostException {
        Sequence sequence = new Sequence(InetAddress.getLocalHost());
        // RequestIdGeneratoræ¥å£å®ç°
        return () -> String.valueOf(sequence.nextId());
    }
}
```

### è‡ªå®šä¹‰JSONåºåˆ—åŒ–å·¥å…·

å½“å‰`Json`åºåˆ—åŒ–æ”¯æŒ`Fast2json`ã€`Fastjson`ã€`Jackson`ã€`Gson`ç­‰ä»»æ„ä¸€ç§ï¼Œå¦‚æœå½“å‰é¡¹ç›®åŒæ—¶å­˜åœ¨ç›¸å…³ä¾èµ–æ—¶ï¼Œåºåˆ—åŒ–ä½¿ç”¨çš„`Json`å·¥å…·ä¼˜å…ˆçº§ä¹ŸåŒä¸Šé¡ºåºã€‚è‹¥éœ€è°ƒæ•´é¡ºåºæˆ–ä½¿ç”¨å…¶ä»–`Json`åºåˆ—åŒ–å·¥å…·æ—¶ï¼Œå¯ä»¥è‡ªå®šä¹‰`Json`å®ç°ï¼Œéœ€å®ç°æ¥å£[IJson](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/support/spi/IJson.java)ã€‚

æ¥å£ï¼š

```java
public interface IJson {
    /**
     * jsonå·¥å…·ç±»åç§°,å¦‚ï¼š"com.alibaba.fastjson2.JSON"
     *
     * @return name
     */
    String className();

    /**
     * to json string
     *
     * @param value v
     * @return json str
     */
    String toJsonString(Object value);

    /**
     * json è½¬å¯¹è±¡
     *
     * @param text text
     * @param type to bean class
     * @return bean
     */
    <T> T parseObject(String text, Type type);

    /**
     * å½“å­˜åœ¨å¤šä¸ªå¯ç”¨çš„jsonå·¥å…·æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨orderæœ€å°çš„
     *
     * @return order é¡ºåº
     */
    int getOrder();
}
```

åˆ›å»ºJsonProviderå¹¶å®ç°æ¥å£IJsonï¼Œéœ€é‡å†™classNameã€toJsonStringã€parseObjectã€getOrderç­‰æ–¹æ³•å³å¯ï¼Œå¯å‚è€ƒ[Fast2jsonProvider](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/support/Fast2jsonProvider.java)çš„å®ç°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```java
public class Fast2jsonProvider implements IJson {  
    @Override
    public String className() {
        return "com.alibaba.fastjson2.JSON";
    }

    @Override
    public String toJsonString(Object value) {
        return JSON.toJSONString(value);
    }

    @Override
    public <T> T parseObject(String text, Type type) {
        return JSON.parseObject(text, type);
    }

    @Override
    public int getOrder() {
        return 1;
    }
}
```

è¿™é‡Œä½¿ç”¨çš„æ˜¯Javaçš„`SPI`æœºåˆ¶ï¼Œæ•…éœ€åœ¨é¡¹ç›®çš„`META-INF/services`ç›®å½•ä¸‹æ·»åŠ `com.github.likavn.eventbus.core.support.spi.IJson`æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```java
com.github.likavn.eventbus.core.support.Fast2jsonProvider
```

### æ¶ˆæ¯ç›‘å¬å™¨å¼€å…³

å¯æ§çš„æ¶ˆæ¯ç›‘å¬å™¨å¼€å…³ï¼Œå¦‚é€šè¿‡`Nacos`ä¸‹çº¿æŸä¸ªæœåŠ¡å®ä¾‹æ—¶éœ€è¦åŒæ—¶å…³é—­æ¶ˆæ¯çš„ç›‘å¬ã€‚

```java
@Resource 
MsgListenerContainer msgListenerContainer;

// æ‰“å¼€æ¶ˆæ¯ç›‘å¬
msgListenerContainer.startup();

// å…³é—­æ¶ˆæ¯ç›‘å¬
msgListenerContainer.shutdown();
```

### å…¨å±€æ¶ˆæ¯æ‹¦æˆªå™¨

`eventbus`
æä¾›å…¨å±€çš„æ¶ˆæ¯æ‹¦æˆªå™¨ï¼ŒåŒ…å«æ¶ˆæ¯å‘é€å‰æ‹¦æˆªå™¨ã€æ¶ˆæ¯å‘é€åæ‹¦æˆªå™¨ã€æ¶ˆæ¯æŠ•é€’å‰æ‹¦æˆªå™¨ã€æ¶ˆæ¯æŠ•é€’åæ‹¦æˆªå™¨ã€å¼‚å¸¸é‡è¯•æœ€åä¸€æ¬¡æŠ•é€’ä»ç„¶å¤±è´¥æ‹¦æˆªå™¨ã€‚å¯æ ¹æ®æ¶ˆæ¯çš„é‡è¦æ€§éœ€æ±‚å®ç°å¯¹åº”çš„æ‹¦æˆªå™¨æ¥å£ï¼Œå¦‚å¯¹æ¶ˆæ¯åŠæ¶ˆæ¯çš„æŠ•é€’æ¶ˆè´¹è€…çŠ¶æ€è¿›è¡Œæ•°æ®åº“æŒä¹…åŒ–æ“ä½œï¼Œå‚è€ƒï¼š[BsHelper](eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/helper/BsHelper.java)ã€‚
å¦‚æœå­˜åœ¨å¤šä¸ªåŒç±»å‹æ‹¦æˆªå™¨å®ä¾‹å¯ä½¿ç”¨[@Order](eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/Order.java)æ³¨è§£æ ‡è¯†ä¼˜å…ˆçº§ã€‚
#### å‘é€å‰æ‹¦æˆªå™¨

æ¶ˆæ¯å‘é€å‰æ‹¦æˆªå™¨ï¼š[SendBeforeInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/SendBeforeInterceptor.java)å®ç°æ¥å£æ–¹æ³•`execute`å³å¯ï¼Œå¦‚ä¸‹ç¤ºä¾‹æ˜¯æ¶ˆæ¯å‘é€å‰æŒä¹…åŒ–æ¶ˆæ¯çš„å®ä¾‹ä»£ç ï¼Œå‚è€ƒï¼š[DemoSendBeforeInterceptor](eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/interceptor/DemoSendBeforeInterceptor.java)

```java
@Component
public class DemoSendBeforeInterceptor implements SendBeforeInterceptor {
  @Resource
  private BsHelper bsHelper;

  @Override
  public void execute(Request<String> request) {
    bsHelper.sendMessage(request);
  }
}
```

#### å‘é€åæ‹¦æˆªå™¨

æ¶ˆæ¯å‘é€åæ‹¦æˆªå™¨ï¼š[SendAfterInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/SendAfterInterceptor.java)å®ç°æ¥å£æ–¹æ³•`execute`å³å¯ã€‚

#### æ¶ˆè´¹å‰æ‹¦æˆªå™¨

æ¶ˆæ¯æŠ•é€’æ¶ˆè´¹è€…å‰æ‹¦æˆªå™¨ï¼š[DeliverBeforeInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/DeliverBeforeInterceptor.java)
å®ç°æ¥å£æ–¹æ³•`execute`å³å¯ï¼Œå¦‚ä¸‹ç¤ºä¾‹æ˜¯æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸåæ›´æ–°æ¶ˆæ¯çš„æŠ•é€’çŠ¶æ€ç¤ºä¾‹ä»£ç ï¼Œ

```java
@Component
public class DemoDeliverBeforeInterceptor implements DeliverBeforeInterceptor {
    @Resource
    private BsHelper bsHelper;

    @Override
    public void execute(Request<String> request) {
        bsHelper.deliverSuccess(request);
    }
}
```

#### æ¶ˆè´¹åæ‹¦æˆªå™¨

æ¶ˆæ¯æŠ•é€’æ¶ˆè´¹è€…åæ‹¦æˆªå™¨ï¼š[DeliverAfterInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/DeliverAfterInterceptor.java)
å®ç°æ¥å£æ–¹æ³•`execute`
å³å¯ï¼Œå¦‚ä¸‹ç¤ºä¾‹æ˜¯æ¶ˆæ¯æ¶ˆè´¹åæ›´æ–°æ¶ˆæ¯çš„æŠ•é€’çŠ¶æ€ç¤ºä¾‹ä»£ç ï¼Œå‚è€ƒï¼š[DemoDeliverAfterInterceptor](eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/interceptor/DemoDeliverAfterInterceptor.java)

```java
public class DemoDeliverAfterInterceptor implements DeliverAfterInterceptor {
  @Lazy
  @Resource
  private BsHelper bsHelper;

  @Override
  public void execute(Request<String> request, Throwable throwable) {
    // æ— å¼‚å¸¸ä¿¡æ¯æ ‡è¯†å½“å‰æ¶ˆæ¯æˆåŠŸæŠ•é€’
    if (null == throwable) {
      bsHelper.deliverSuccess(request);
      return;
    }
    log.info("æ¶ˆæ¯æŠ•é€’å¼‚å¸¸ execute->{}", throwable.getMessage());
    bsHelper.deliverException(request, throwable);
  }
}
```

#### æ¶ˆè´¹å¤±è´¥æ‹¦æˆªå™¨

æ¶ˆæ¯æŠ•é€’æ¶ˆè´¹è€…å¤±è´¥æ‹¦æˆªå™¨ï¼ˆæ¶ˆæ¯é‡è¯•æŠ•é€’éƒ½å¤±è´¥æ—¶ï¼Œæœ€åä¸€æ¬¡æ¶ˆæ¯æŠ•é€’ä»ç„¶å¤±è´¥æ—¶ä¼šè°ƒç”¨è¯¥æ‹¦æˆªå™¨ï¼‰ï¼š[DeliverThrowableLastInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/DeliverThrowableLastInterceptor.java)
å®ç°æ¥å£æ–¹æ³•`execute`å³å¯ï¼Œ
å¦‚ä¸‹ç¤ºä¾‹æ˜¯æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åæ›´æ–°æ¶ˆæ¯çš„æŠ•é€’çŠ¶æ€ç¤ºä¾‹ä»£ç ï¼Œå‚è€ƒï¼š[DemoDeliverThrowableInterceptor](eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/interceptor/DemoDeliverThrowableInterceptor.java)

```java
@Component
public class DemoDeliverThrowableInterceptor implements DeliverThrowableInterceptor {
    @Resource
    private BsHelper bsHelper;

    @Override
    public void execute(Request<String> request, Throwable throwable) {
        bsHelper.deliverException(request, throwable);
    }
}
```

### åŠæ—¶è½¬æˆå»¶æ—¶æ¶ˆæ¯

åœ¨åŠæ—¶æ¶ˆæ¯ç›‘å¬å™¨çš„æ–¹æ³•ä¸Šé…ç½®æ³¨è§£[@ToDelay](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/ToDelay.java)  å³å¯è®©åŠæ—¶æ¶ˆæ¯è½¬æˆå»¶æ—¶æ¶ˆæ¯å¹¶æ¥æ”¶å¤„ç†ã€‚ç¤ºä¾‹ï¼š[DemoMsgListener](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/DemoMsgListener.java) </br>

å‚æ•°é…ç½®ï¼š</br>
delayTime ï¼šå»¶è¿Ÿæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</br>
firstDeliver ï¼šæ˜¯å¦éœ€è¦åŠæ—¶æ¶ˆæ¯è¿›è¡Œé¦–æ¬¡æŠ•é€’ï¼Œé»˜è®¤ï¼šfalse (ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°åŠæ—¶æ¶ˆæ¯æ—¶ä¸æŠ•é€’ï¼ŒåªæŠ•é€’å»¶æ—¶æ¶ˆæ¯ï¼‰ã€‚</br>

```java
/**
 * codes : æ¶ˆæ¯code
 * concurrency : å¹¶å‘æ•°
 */
@Component
@EventbusListener(codes = MsgConstant.DEMO_MSG_LISTENER, concurrency = 2)
public class DemoMsgListener extends MsgListener<TestBody> {

    @Override
    @ToDelay(delayTime = 3)
    public void onMessage(Message<TestBody> msg) {
        TestBody body = msg.getBody();
    }
}
```

### æ¶ˆæ¯è½®è¯¢

åœ¨æ¶ˆæ¯ç›‘å¬å™¨çš„æ–¹æ³•ä¸Šé…ç½®æ³¨è§£[@Polling](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/Polling.java)
å³å¯è®©åŒä¸€æ¶ˆæ¯é‡å¤è½®è¯¢æ¥æ”¶ï¼Œå¯é…ç½®countï¼ˆæœ€å¤§è½®è¯¢æ¬¡æ•°ï¼Œå¯é€šè¿‡ç¼–ç æ–¹å¼`Polling.Keep.over()`
æå‰ç»ˆæ­¢è½®è¯¢ï¼‰ã€intervalï¼ˆè½®è¯¢é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’ï¼‰ï¼Œå€¼å¯ä»¥ä¸ºæ•°å­—ä¹Ÿå¯ä¸ºè®¡ç®—é—´éš”æ—¶é—´çš„è¡¨è¾¾å¼ï¼ˆå¼•ç”¨å˜é‡æ—¶ä½¿ç”¨"$"+å˜é‡åï¼Œä¾‹å¦‚"$
count"ï¼‰ã€‚[MsgListener](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/MsgListener.java)

ç¤ºä¾‹ï¼š

1. `interval=7`ï¼Œè¡¨ç¤ºè½®è¯¢é—´éš”ä¸º7ç§’ã€‚
2. `interval=$count*$intervalTime`ï¼Œè¡¨ç¤ºè½®è¯¢é—´éš”ä¸ºå½“å‰è½®è¯¢æ¬¡æ•°ä¸ä¸Šæ¬¡è½®è¯¢çš„æ—¶é—´é—´éš”çš„ä¹˜ç§¯ã€‚

æ³¨ï¼šè¡¨è¾¾å¼ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸‰ä¸ªå˜é‡ï¼Œcountï¼ˆå½“å‰è½®è¯¢æ¬¡æ•°ï¼‰ã€deliverCountï¼ˆå½“å‰æŠ•é€’æ¬¡æ•°ï¼‰å’ŒintervalTimeï¼ˆæœ¬æ¬¡è½®è¯¢ä¸ä¸Šæ¬¡è½®è¯¢çš„æ—¶é—´é—´éš”ï¼Œå•ä½ä¸ºç§’ï¼Œéå»¶æ—¶æ¶ˆæ¯åˆå§‹æ—¶ä¸º:1ï¼‰

```java
@Component
@EventbusListener(codes = MsgConstant.DEMO_MSG_LISTENER, concurrency = 2)
public class DemoMsgListener extends MsgListener<TestBody> {
    @Override
    @Polling(count = 2, interval = "$count * $intervalTime + 5")
    public void onMessage(Message<TestBody> message) {
        TestBody body = message.getBody();
        log.info("æ¥æ”¶æ•°æ®: {}", message.getRequestId());
        //   throw new RuntimeException("DemoMsgListener test");

        if (message.getDeliverCount() > 1) {
            // ç»ˆæ­¢è½®è¯¢
            Polling.Keep.over();
        }
    }
}
```

### åˆ‡æ¢æ¶ˆæ¯ä¸­é—´ä»¶

eventbusæ”¯æŒå¤šç§æ¶ˆæ¯å¼•æ“ï¼Œå¦‚ï¼šredisã€rabbitmqã€rocketmqï¼Œå¦‚æœé¡¹ç›®å‰æœŸä½¿ç”¨redisï¼Œåç»­éœ€è¦åˆ‡æ¢åˆ°rabbitmqï¼Œå¯ä¸åœ¨ä¿®æ”¹ä»£ç çš„åŒæ—¶ä½¿å¾—å½“å‰æœåŠ¡å¯ä»¥ç›‘å¬åŸæœ‰redisä¸­çš„æ¶ˆæ¯ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```yaml
eventbus:
  oldType: redis # åŸæ¶ˆæ¯å¼•æ“ç±»åˆ«ï¼Œæ¶ˆæ¯å¼•æ“æ²¡åšè¿ç§»æ—¶å¯ä¸åšé…ç½®
  type: rabbitmq # åˆ‡æ¢åçš„æ¶ˆæ¯å¼•æ“ç±»åˆ«
```

## é…ç½®

`BusProperties`ï¼Œåœ¨application.yamlä¸­eventbusé…ç½®ä»¥ `eventbus` å¼€å¤´ï¼Œæ‰€æœ‰é…ç½®å¦‚ä¸‹ï¼š


| èŠ‚ç‚¹        | key                             | æ•°æ®ç±»å‹ | å¤‡æ³¨                                                            |
| ----------- | ------------------------------- | -------- |---------------------------------------------------------------|
| eventbus    |                                 |          | eventbusé…ç½®                                                    |
| eventbus    | serviceId                       | string   | æœåŠ¡ID/æ¶ˆæ¯æ¥æºIDï¼Œå¯ä»¥ä¸ç”¨é…ç½®ï¼Œé»˜è®¤ç­‰äº${spring.application.name}çš„å€¼ã€‚                |
| eventbus    | type                            | string   | æ¶ˆæ¯å¼•æ“ç±»åˆ«ï¼ˆredisã€rabbitmqã€rocketmqï¼‰                               |
| eventbus    | oldType                         | string   | åŸæ¶ˆæ¯å¼•æ“ç±»åˆ«ï¼ˆredisã€rabbitmqã€rocketmqï¼‰ï¼Œç”¨äºæ¶ˆæ¯å¼•æ“åˆ‡æ¢æ—¶å…¼å®¹åŸå§‹æ¶ˆæ¯ï¼Œæ¶ˆæ¯å¼•æ“æ²¡åšè¿ç§»æ—¶å¯ä¸åšé…ç½® |
| eventbus    | concurrency                     | int      | æ¶ˆæ¯æ¥æ”¶å¹¶å‘æ•°ï¼Œé»˜è®¤ä¸ºï¼š2                                                 |
| eventbus    | retryConcurrency                | int      | é‡å‘/é‡è¯•æ¶ˆæ¯æ¥æ”¶å¹¶å‘æ•°ï¼Œé»˜è®¤ä¸ºï¼š1                                            |
| eventbus    | msgBatchSize                    | int      | å•æ¬¡è·å–æ¶ˆæ¯æ•°é‡ï¼Œé»˜è®¤ï¼š16æ¡                                               |
| eventbus    | testConnect                     |          | æ¶ˆæ¯å¼•æ“æœåŠ¡èŠ‚ç‚¹è”é€šæ€§é…ç½®                                                 |
| testConnect | pollSecond                      | int      | è½®è¯¢æ£€æµ‹æ—¶é—´é—´éš”ï¼Œå•ä½ï¼šç§’ï¼Œé»˜è®¤ï¼š35ç§’è¿›è¡Œæ£€æµ‹ä¸€æ¬¡                                    |
| testConnect | loseConnectMaxMilliSecond       | int      | ä¸¢å¤±è¿æ¥æœ€é•¿æ—¶é—´å¤§äºç­‰äºæ¬¡å€¼è®¾ç½®ç›‘å¬å®¹å™¨ä¸ºè¿æ¥æ–­å¼€ï¼Œå•ä½ï¼šç§’ï¼Œé»˜è®¤ï¼š120ç§’                        |
| eventbus    | fail                            |          | æ¶ˆæ¯æŠ•é€’å¤±è´¥æ—¶é…ç½®                                                     |
| fail        | retryCount                      | int      | æ¶ˆæ¯æŠ•é€’å¤±è´¥æ—¶ï¼Œä¸€å®šæ—¶é—´å†…å†æ¬¡è¿›è¡ŒæŠ•é€’çš„æ¬¡æ•°ï¼Œé»˜è®¤ï¼š3æ¬¡                                  |
| fail        | nextTime                        | int      | å¤±è´¥é‡è¯•ä¸‹æ¬¡è§¦å‘æ—¶é—´ï¼Œå•ä½ï¼šç§’ï¼Œé»˜è®¤10ç§’ ã€‚ï¼ˆrocketMqè¯·ä¿®æ”¹ä¸ºå¯¹åº”ä¸º18ä¸ªå»¶æ—¶æ¶ˆæ¯çº§åˆ«ï¼‰             |
| eventbus    | redis                           |          | redisé…ç½®                                                       |
| redis       | pollThreadPoolSize              | int      | è½®è¯¢æ—¶æ‹‰å–Redis Streamä¸­æ¶ˆæ¯çš„çº¿ç¨‹æ± å¤§å°ï¼Œé»˜è®¤ä¸ºï¼š2                              |
| redis       | pollBlockMillis                 | long     | è½®è¯¢æ—¶æ‹‰å–Redis Streamä¸­æ¶ˆæ¯çš„é˜»å¡æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ï¼Œé»˜è®¤ä¸ºï¼š5ms                       |
| redis       | deliverGroupThreadPoolSize      | int      | æŠ•é€’æ¶ˆæ¯çš„åˆå§‹åŒ–çº¿ç¨‹æ± å¤§å°ï¼Œé»˜è®¤ä¸ºï¼š5                                           |
| redis       | deliverGroupThreadKeepAliveTime | long     | æŠ•é€’æ¶ˆæ¯çº¿ç¨‹æ± ä¸­ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ï¼Œé»˜è®¤ä¸ºï¼š60s                                |
| redis       | deliverTimeout                  | int      | æ¶ˆæ¯è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶æ¶ˆæ¯æœªè¢«ç¡®è®¤ï¼Œæ‰ä¼šè¢«é‡æ–°æŠ•é€’ï¼Œå•ä½ï¼šç§’ï¼Œé»˜è®¤ï¼š5åˆ†é’Ÿ                           |
| redis       | pendingMessagesBatchSize        | int      | æœªç¡®è®¤æ¶ˆæ¯ï¼Œé‡æ–°æŠ•é€’æ—¶æ¯æ¬¡æœ€å¤šæ‹‰å–å¤šå°‘æ¡å¾…ç¡®è®¤æ¶ˆæ¯æ•°æ®ï¼Œé»˜è®¤ï¼š100æ¡                           |
| redis       | streamExpiredHours              | int      | stream è¿‡æœŸæ—¶é—´ï¼Œ6.2åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒï¼Œå•ä½ï¼šå°æ—¶ï¼Œé»˜è®¤ï¼š3 å¤©                           |
| redis       | streamExpiredLength             | int      | stream è¿‡æœŸæ•°æ®æˆªå–ï¼Œå€¼ä¸ºå½“å‰ä¿ç•™çš„æ¶ˆæ¯æ•°ï¼Œ5.0~<6.2ç‰ˆæœ¬æ”¯æŒï¼Œå•ä½ï¼šæ¡ï¼Œé»˜è®¤ï¼š10000æ¡          |

## æ¥å£ä¿¡æ¯

| æ¥å£                                                                                                                                                    | è¯´æ˜                                                   | ç¤ºä¾‹                                                                                                                                                                                                                                                            |
|-------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [MsgSender](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/MsgSender.java)                                                         | æ¶ˆæ¯çš„ç”Ÿäº§è€…sender,ç”¨äºæ¶ˆæ¯çš„å‘é€                                 | [TriggerController](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/controller/TriggerController.java)                                                                                                                          |
| [MsgListener](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/MsgListener.java)                                                     | æ¥æ”¶åŠæ—¶æ¶ˆæ¯çš„å¤„ç†å™¨æ¥å£ç±»                                        | [MsgListener ](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/MsgListener.java)<br/>[MsgListener2](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/MsgListener2.java)          |
| [MsgDelayListener](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/MsgDelayListener.java)                                           | æ¥æ”¶å»¶æ—¶æ¶ˆæ¯çš„å¤„ç†å™¨æ¥å£ç±»                                        | [MsgDelayListener ](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/MsgDelayListener.java)                                                                                                                             |
| [@EventbusListener](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/EventbusListener.java)                                   | @EventbusListener æ³¨è§£ï¼Œç”¨äºæ ‡è¯†æ˜¯Eventbusæ¶ˆæ¯ç›‘å¬å™¨çš„æ³¨è§£           | [MsgListener ](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/MsgListener.java)<br/>[MsgDelayListener ](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/MsgDelayListener.java) |
| [@FailRetry](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/FailRetry.java)                                                 | @FailRetry æ³¨è§£ï¼Œç”¨äºåœ¨æ¥æ”¶æ¶ˆæ¯æŠ•é€’å¼‚å¸¸æ—¶å®šä¹‰é‡è¯•æ¬¡æ•°å’Œä¸‹æ¬¡è§¦å‘æ—¶é—´              | [MsgListener](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/MsgListener.java)                                                                                                                                        |
| [SendBeforeInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/SendBeforeInterceptor.java)                     | å‘é€å‰å…¨å±€æ‹¦æˆªå™¨                                             | [DemoSendBeforeInterceptor](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/interceptor/DemoSendBeforeInterceptor.java)                                                                                                         |
| [SendAfterInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/SendAfterInterceptor.java)                       | å‘é€åå…¨å±€æ‹¦æˆªå™¨                                             | [DemoSendAfterInterceptor](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/interceptor/DemoSendAfterInterceptor.java)                                                                                                           |
| [DeliverBeforeInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/DeliverBeforeInterceptor.java)               | æŠ•é€’æ¶ˆè´¹è€…å‰å…¨å±€æ‹¦æˆªå™¨                                          |                                                                                                                                                                                                                                                               |
| [DeliverAfterInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/DeliverAfterInterceptor.java)                 | æŠ•é€’æ¶ˆè´¹è€…åå…¨å±€æ‹¦æˆªå™¨                                          | [DemoDeliverAfterInterceptor](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/interceptor/DemoDeliverAfterInterceptor.java)                                                                                                     |
| [DeliverThrowableLastInterceptor](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/api/interceptor/DeliverThrowableLastInterceptor.java) | æŠ•é€’æ¶ˆè´¹è€…å¼‚å¸¸å…¨å±€æ‹¦æˆªå™¨<br/> * æ³¨ï¼šæ¶ˆæ¯é‡å¤æŠ•é€’éƒ½å¤±è´¥æ—¶ï¼Œæœ€åä¸€æ¬¡æ¶ˆæ¯æŠ•é€’å¤±è´¥æ—¶æ‰ä¼šè°ƒç”¨è¯¥æ‹¦æˆªå™¨ | [DemoDeliverThrowableInterceptor](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/interceptor/DemoDeliverThrowableInterceptor.java)                                                                                             |
| [@ToDelay](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/ToDelay.java)                                                     | @ToDelay æ³¨è§£ç”¨äºæ¥æ”¶åŠæ—¶æ¶ˆæ¯çš„æ–¹æ³•ä¸Šï¼Œä½¿å¾—å½“å‰æ¶ˆæ¯è½¬æˆå»¶æ—¶æ¶ˆæ¯ã€‚                | [DemoMsgListener](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/DemoMsgListener.java)                                                                                                                                |
| [@Polling](./eventbus-core/src/main/java/com/github/likavn/eventbus/core/annotation/Polling.java)                                                     | @Polling æ³¨è§£ç”¨åœ¨æ¥æ”¶æ¶ˆæ¯çš„æ–¹æ³•ä¸Šï¼Œä»¥æ§åˆ¶æ¶ˆæ¯è®¢é˜…çš„è½®è¯¢è¡Œä¸ºã€‚                  | [DemoMsgListener](./eventbus-demo/springboot-demo/src/main/java/com/github/likavn/eventbus/demo/listener/DemoMsgListener.java)                                                                                                                                |

æ›´å¤šä¿¡æ¯è¯·æŸ¥é˜…ç›¸å…³æ¥å£ç±»...

## æ¶æ„

è¯¦æƒ…è§[æ¶æ„çŸ¥ä¹‹](./doc/æ¶æ„çŸ¥ä¹‹.md)

## ç¤ºä¾‹

ç¤ºä¾‹é¡¹ç›®éœ€é…ç½®æ•°æ®åº“ï¼Œåˆå§‹åŒ–æ•°æ®åº“sqlï¼š[demo-init.sql](./doc/sql/demo-init.sql)

å¯åŠ¨springboot-demoè®¿é—®http://localhost:8080/index.html <br/>
<img src="./doc/picture/event_send.jpg" alt="event_send" style="zoom: 33%; margin-left: 0px;" />

## æ³¨æ„äº‹é¡¹

**è®¢é˜…ã€å¹¿æ’­æ¶ˆæ¯åœ¨æ¶ˆæ¯å¼•æ“ä¸­æ˜¯ä»¥ç›‘å¬å™¨å®ç°ç±»å…¨ç±»åå®ç°ï¼Œè¯·è°¨æ…é‡æ–°å‘½åç›‘å¬å™¨ï¼Œå½“æˆ‘ä»¬ä¸åœ¨éœ€è¦æŸä¸ªç›‘å¬å™¨è¯·åŠæ—¶åœ¨æ¶ˆæ¯å¼•æ“ä¸­åˆ é™¤æ­¤åˆ†ç»„æˆ–é˜Ÿåˆ—ï¼Œé¿å…ä¸å¿…è¦çš„å­˜å‚¨ç©ºé—´æµªè´¹ã€‚æ¶ˆæ¯ç›‘å¬å™¨åªèƒ½æ˜¯åŠæ—¶/å»¶æ—¶å…¶ä¸­çš„ä¸€ç§ç±»å‹ï¼ŒåŒä¸€ä¸ªæ¶ˆæ¯ç›‘å¬å™¨ä¸å¯èƒ½åŒæ—¶ç›‘å¬åŠæ—¶å’Œå»¶æ—¶æ¶ˆæ¯**

## è”ç³»æˆ‘

æœ¬é¡¹ç›®ä¼šæŒç»­æ›´æ–°å’Œç»´æŠ¤ï¼Œå–œæ¬¢åˆ«å¿˜äº†Starï¼Œæœ‰é—®é¢˜å¯é€šè¿‡å¾®ä¿¡ã€QQåŠæ—¶ä¸æˆ‘è”ç³»(è¯·å¤‡æ³¨æ¥æºå¹³å°åŠæ¥æ„)ï¼Œè°¢è°¢æ‚¨çš„å…³æ³¨ã€‚

å¾®ä¿¡ï¼šlikavn

QQï¼š1085257460
